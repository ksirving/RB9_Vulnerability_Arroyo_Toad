## get COMIDs for grids

# packages
library(tidyverse)
library(tidylog)
library(nhdplusTools)

## final probabilities
data_sf <- st_read("ignore/ModelResults/Gridded/09_Av_Probs_Current_RB9.shp")

head(data_sf)

orig.sdata.segs <- data_sf %>%
  dplyr::select(x,y, cells) %>%
  # st_as_sf(coords=c("x", "y"), crs=26911, remove=F)%>%
  st_transform(crs=32611) %>%
  arrange(cells)

# use nhdtools to get comids
data_all_coms <- orig.sdata.segs %>%
  group_split(cells) %>%
  set_names(., orig.sdata.segs$cells) %>%
  map(~discover_nhdplus_id(.x$geometry))

# flatten into single dataframe instead of list
data_segs_df <-data_all_coms %>% flatten_dfc() %>% t() %>%
  as.data.frame() %>%
  rename("COMID"=V1) %>% rownames_to_column(var = "cells") %>%
  mutate(cells = as.integer(cells))
data_segs_df

## join back to DF
ProbComs <- full_join(data_sf, data_segs_df, by = "cells")

head(ProbComs)
class(ProbComs)

st_write(ProbComs, "ignore/ModelResults/Gridded/10_Av_Probs_Current_RB9_COMIDs.shp", append=F)
# length(unique(ProbComs$COMID))
# ind <- which(is.na(ProbComs$COMID))
# test <- ProbComs[ind,]
# ind2 <- test$cells
# 
# filter(ProbComs, cells %in% ind2)


# Check new data ----------------------------------------------------------

ProbComs <- read.csv("ignore/ModelResults/Gridded/Probs_Current_RB9_COMIDCHECK.csv")
head(ProbComs)

length(unique(ProbComs$grid_code))
sum(is.na(ProbComs))

ProbComsx <- ProbComs %>%  
  dplyr::select(-COMID, -ComIDCheck, -Ras_Lat, -Ras_Long) %>%
  rename(COMID = grid_code) %>%
  st_as_sf(coords=c("x", "y"), crs=26911, remove=F) ## 1865

head(ProbComsx)

## save out
write.csv(ProbComsx, "ignore/ModelResults/Gridded/Arroyo_Toad_Prob_Occurrence_RB9.csv")
st_write(ProbComsx, "ignore/ModelResults/Gridded/Arroyo_Toad_Prob_Occurrence_RB9.shp")

# 
# delta <- read.csv("/Users/katieirving/Library/CloudStorage/OneDrive-SharedLibraries-SCCWRP/SD Hydro Vulnerability Assessment - General/Data/RawData/Data_for_SDSU/R/data/Output_09/2022-11-29_predicted_abs_FFMq99_deltaFFMq99_SD_COMIDS_medianDelta_test2q99_test12FFM_allgages.csv")
# head(delta)
# 
# sum(unique(ProbComs$grid_code) %in% unique(delta$comid)) ## 1851
