### physical data

## data formatting

# packages
library(tidyverse)
library(tidylog)
library(sf)
library(raster)
library(nhdplusTools)
library(readr)
library(mapview)
library(stars)
library(rgdal)
library(rgeos)
library(terra)
library(zoo)


## upload basse raster with comids

bmask <- raster("input_data/Elev.tif")
# names(bmask) <- "COMID"
bmask

# gridsDF <- as.data.frame(bmask, xy=T) %>%
#   st_as_sf(coords=c("x", "y"), crs=26911, remove=F)  %>%
#   st_transform(crs = 9001)
# 
# head(gridsDF)
# 
# save(gridsDF, file = "ignore/00_10m_grids_comids_df.RData")
# 
# gridsDF <- na.omit(gridsDF)

# length(unique(gridsDF$NHD_10m)) ## 2179

# Format Climate data -------------------------------------------------

## RB9 boundary
bmask@extent

#### upload annual climate data

## precipitation ###
ppt_ann <- st_read("/Users/katieirving/Library/CloudStorage/OneDrive-SharedLibraries-SCCWRP/PRISM - General/Data/prism_annual average ppt_30yr.shp") %>%
  rename(ppt_annx = PRISM__) 
## make spatial and transformCRS
ppt_annSP <- as(ppt_ann, Class = "Spatial")
ppt_annSP <- spTransform(ppt_annSP, CRS("+proj=utm +zone=11 +datum=NAD83 +units=m +no_defs"))

## create raster 
ppt_annR <- rasterize(ppt_annSP, bmask,  'ppt_annx',  na.rm =TRUE, sp = TRUE)

## max temperature ###
tmax_ann <- st_read("/Users/katieirving/Library/CloudStorage/OneDrive-SharedLibraries-SCCWRP/PRISM - General/Data/prism_annual average tmax_30yr.shp") %>% 
  rename(tmax_annx = PRISM__)
## make spatial and transformCRS
tmax_annSP <- as(tmax_ann, Class = "Spatial")
tmax_annSP <- spTransform(tmax_annSP, CRS("+proj=utm +zone=11 +datum=NAD83 +units=m +no_defs"))

## create raster 
tmax_annR <- rasterize(tmax_annSP, bmask,  'tmax_annx',  na.rm =TRUE, sp = TRUE)

## min temp
tmin_ann <- st_read("/Users/katieirving/Library/CloudStorage/OneDrive-SharedLibraries-SCCWRP/PRISM - General/Data/prism_annual average tmin_30yr.shp") %>% 
  rename(tmin_annx = PRISM__)

## make spatial and transformCRS
tmin_annSP <- as(tmin_ann, Class = "Spatial")
tmin_annSP <- spTransform(tmin_annSP, CRS("+proj=utm +zone=11 +datum=NAD83 +units=m +no_defs"))

## create raster 
tmin_annR <- rasterize(tmin_annSP, bmask,  'tmin_annx',  na.rm =TRUE, sp = TRUE)

## stack all together
annStack <- stack(ppt_annR, tmax_annR, tmin_annR)

## name layers
names(annStack) <- c("ppt_ann", "tmax_ann", "tmin_ann")

writeRaster(annStack, "ignore/00_ann_clim_raster_stack.tif", format="GTiff", crs="+proj=utm +zone=11 +datum=NAD83 +units=m +no_defs ", overwrite=TRUE)

## crop to original layer
annCrop<- crop(annStack, bmask)

## resample to extent of original layer
annCropRes <- resample(annCrop, bmask,  method = "bilinear")

## stack with comids
annComs <- stack(bmask, annCropRes)

writeRaster(annComs, "ignore/00_ann_clim_raster_stack_200.tif", format="GTiff", crs="+proj=utm +zone=11 +datum=NAD83 +units=m +no_defs ", overwrite=TRUE)

### monthly climate data


# Remote Sensing data -----------------------------------------------------
## upload raw data

sept <- brick("/Users/katieirving/OneDrive - SCCWRP/Documents - Katie’s MacBook Pro/git/Arroyo_toad_RB9_V2/ignore/TC_2014_RB9/TC_092014_RB9.tif")
sept ## is 30m grids, disaggregate to 10m

## aggregate to 180m by median
sept180Med <- aggregate(sept, 6, fun = "median")
names(sept180Med) <- paste0(names(sept180Med), "_Med")

## aggregate to 180m by variance
sept180Var <- aggregate(sept, 6, fun = "var")
names(sept180Var) <- paste0(names(sept180Var), "_Var")

## stack rasters
sept180 <- stack(sept180Med, sept180Var)

## match projection with mask raster
crs(sept180)<-crs(bmask)

## resample to mask layer (200m)
septr <- resample(sept180, bmask, method = "bilinear")
names(septr)

## upload wet season data
april <- brick("/Users/katieirving/OneDrive - SCCWRP/Documents - Katie’s MacBook Pro/git/Arroyo_toad_RB9_V2/ignore/TC_2014_RB9/TC_042014_RB9.tif")

## aggregate to 180m by median
april180Med <- aggregate(april, 6, fun = "median")
names(april180Med) <- paste0(names(april180Med), "_Med")

## aggregate to 180m by variance
april180Var <- aggregate(april, 6, fun = "var")
names(april180Var) <- paste0(names(april180Var), "_Var")

## stack rasters
april180 <- stack(april180Med, april180Var)

## match projection with mask raster
crs(april180)<-crs(bmask)

## resample to mask layer (200m)
aprilr <- resample(april180, bmask, method = "bilinear")
names(aprilr)

tassR <- stack(aprilr, septr, annComs)
tassR

Rnames <- names(tassR)
Rnames

## crop to original raster
tassR <- crop(tassR, bmask)
plot(tassR)
plot(bmask)
## save out
writeRaster(tassR, "ignore/00_ann_clim_tass_cap_raster_stack_200.tif", format="GTiff", crs="+proj=utm +zone=11 +datum=NAD83 +units=m +no_defs ", overwrite=TRUE)

## save names
save(Rnames, file= "ignore/00_ann_clim_tass_cap_raster_stack_200_names.RData")

## check
# tassR <- stack("ignore/00_ann_clim_tass_cap_raster_stack_200.tif")
# tassR



# COMIDs as DF ------------------------------------------------------------
## aggrregate comid raster 10m to 200m

Cmask <- raster("input_data/NHD_10m.tif")
names(Cmask) <- "COMID"
# 
# gridsR <- aggregate(Cmask, 20, fun = "max")
# gridsR
# 
# gridsRRes <- resample(gridsR, bmask, method = "ngb")
# gridsRRes
# plot(gridsRRes)
## compare with end data raster

gridsDF <- as.data.frame(Cmask, xy=T) %>%
  st_as_sf(coords=c("x", "y"), crs=26911, remove=F) 

head(gridsDF)

save(gridsDF, file = "ignore/00_10m_grids_comids_df.RData")

gridsDF <- na.omit(gridsDF)

length(unique(gridsDF$NHD_10m)) ## 1638



# Add other variables -----------------------------------------------------
## made in GIS by Abel

## ffm rasters
hyd1 <- raster("input_data/DS_Mag_50.tif")
hyd2 <- raster("input_data/FA_Mag.tif")
hyd3 <- raster("input_data/Peak_2.tif")
hyd4 <- raster("input_data/Peak_5.tif")
hyd5 <- raster("input_data/Peak_10.tif")
hyd6 <- raster("input_data/Q99.tif")
hyd7 <- raster("input_data/SP_Mag.tif")
hyd8 <- raster("input_data/Wet_BFL_Mag_10.tif")
hyd9 <- raster("input_data/Wet_BFL_Mag_50.tif")

ffmR <- stack(hyd1, hyd2, hyd3, hyd4, hyd5, hyd6, hyd7, hyd8, hyd9)
ffmR

# plot(hyd1)

### landscape
elev <- raster("input_data/Elev.tif")
slope <- raster("input_data/Slope.tif")
CatchArea <- raster("input_data/AccFlow.tif")
MRVBF <- raster("input_data/MRVBF.tif")
VRM3 <- raster("input_data/VRM3.tif")
VRM18 <- raster("input_data/VRM18.tif")

lanR <- stack(elev, slope, CatchArea, MRVBF, VRM3,  VRM18)

## Soil
AWC <- raster("input_data/AWC_r.tif") ## big chunk missing, add back when fixed
Clay <- raster("input_data/PercentClay.tif")
Sand <- raster("input_data/PercentSand.tif")
Silt <- raster("input_data/PercentSilt.tif")

# plot(AWC)
# plot(Clay)

soilR <- stack(Clay, Sand, Silt)

## stack together
allR <- stack(lanR, soilR)
# plot(allR)
names(allR)
## resample ffm to other rasters

ffmRes <- resample(ffmR, elev, method = "bilinear")
AWCRes <- resample(AWC, elev, method = "bilinear")

## stack with other

allRx <- stack(ffmRes, AWCRes, allR)
allRx


# Join to climate and tass ------------------------------------------------

## load raster and names
load(file= "ignore/00_ann_clim_tass_cap_raster_stack_200_names.RData")
tassR <- stack("ignore/00_ann_clim_tass_cap_raster_stack_200.tif")
names(tassR) <- Rnames
names(tassR)

tassR <- tassR[[c(1:3, 7:9, 13:15, 19:21)]] ## remove unnecc layers, change as needed
tassR

allR <- stack(allRx, tassR)

LayerNames <- names(allR)
LayerNames
save(LayerNames, file = "output_data/00_final_raster_layer_names.RData")


writeRaster(allR, "ignore/00_all_rasters_200m.tif", format="GTiff", crs="+proj=utm +zone=11 +datum=NAD83 +units=m +no_defs ", overwrite=TRUE)

#### below not needed!
# ## make into dataframe to remove NAs
# allRDF <- as.data.frame(allR, xy=T)
# head(allRDF)
# 
# ## remove NAs based on elevation - this removes extra grids from tass cap 
# allRDF <- allRDF %>%
#   drop_na(Elev)
# 
# allRDF$AWC <- na.approx(allRDF$AWC)
# allRDF$PercentClay <- na.approx(allRDF$PercentClay)
# allRDF$PercentSand <- na.approx(allRDF$PercentSand)
# allRDF$PercentSilt <- na.approx(allRDF$PercentSilt)
# allRDF$Slope <- na.approx(allRDF$Slope)
# allRDF$VRM18 <- na.approx(allRDF$VRM18)
# which(is.na(allRDF$VRM18))
# length(allRDF$VRM18)
# ## remove all remaining NAs - removes ffm we don't have values for
# 
# allRDF <- na.omit(allRDF)
# dim(allRDF)
# 
# ## make into rasters
# x <- bmask
# ## make spatial and transformCRS
# coordinates(allRDF) <- ~x+y
# 
# projection(allRDF) <- "+proj=utm +zone=11 +datum=NAD83 +units=m +no_defs"
# allRDF
# 
# #Create list of column names you want to rasterize
# fields <- names(allRDF) #[-c(1:2)]
# fields
# 
# ## make rasters of each env var
# for (i in fields){
#   x[[i]]<-raster::rasterize(allRDF, x, field=i, na.rm =TRUE, sp = TRUE)
#   projection(x)<-"+proj=utm +zone=11 +datum=NAD83 +units=m +no_defs"
#   x <- stack(x)
# }
# 
# x@layers ## check
# plot(x[[30]])
# 
# LayerNames <- names(x)
# 
# save(LayerNames, file = "output_data/00_final_raster_layer_names.RData")
# 
# writeRaster(x, "ignore/00_all_rasters_200m.tif", format="GTiff", crs="+proj=utm +zone=11 +datum=NAD83 +units=m +no_defs ", overwrite=TRUE)




# Format and join hydro ---------------------------------------------------
# 
# delta <- read.csv("/Users/katieirving/Library/CloudStorage/OneDrive-SharedLibraries-SCCWRP/SD Hydro Vulnerability Assessment - General/Data/RawData/Data_for_SDSU/R/data/output_12/Relative_Alteration_bins_deltaFFMtest12_deltaQ99test2.csv")
# head(delta)
# 
# ## change names of columns
# delta_long <- delta %>% 
#   rename(FlowMetric = metric, MetricValue = abs_FFM_median_cfs, DeltaH = delta_FFM_median_cfs) %>%
#   filter(!is.na(FlowMetric)) %>%
#   distinct()
# 
# unique(delta_long$hydro.endpoint)
# 
# ## change names of metrics
# delta_long <- delta_long %>%
#   filter(!FlowMetric %in% c( "ds_mag_90")) %>%
#   mutate(hydro.endpoint = case_when(FlowMetric == "ds_mag_50" ~ "DS_Mag_50",
#                                     FlowMetric == "q99" ~ "Q99",
#                                     FlowMetric == "ds_mag_90" ~ "DS_Mag_90",
#                                     FlowMetric == "fa_mag" ~ "FA_Mag",
#                                     FlowMetric == "peak_10" ~ "Peak_10",
#                                     FlowMetric == "peak_2" ~ "Peak_2",
#                                     FlowMetric == "peak_5" ~ "Peak_5",
#                                     FlowMetric == "sp_mag" ~ "SP_Mag",
#                                     FlowMetric == "wet_bfl_mag_10" ~ "Wet_BFL_Mag_10",
#                                     FlowMetric == "wet_bfl_mag_50" ~ "Wet_BFL_Mag_50")) 
# 
# 
# 
# ## values are median, reformat wide
# delta_med <- delta_long %>%
#   dplyr::select(-FlowMetric, ref.ffm:Relative_Alteration)  %>%
#   group_by(comid,hydro.endpoint) %>%
#   summarise(MedDelta = MetricValue) %>%
#   ungroup() %>%
#   rename(COMID = comid) %>%
#   pivot_wider(names_from = hydro.endpoint, values_from = MedDelta) %>% dplyr::select(COMID:Wet_BFL_Mag_50)
# delta_med
# 
# write.csv(delta_med, "output_data/00_abs_median_comids_2116.csv")
# 
# delta_med <- delta_long %>%
#   dplyr::select(-FlowMetric, ref.ffm:Relative_Alteration)  %>%
#   group_by(comid,hydro.endpoint) %>%
#   summarise(MedDelta = DeltaH) %>%
#   ungroup() %>%
#   rename(COMID = comid) %>%
#   pivot_wider(names_from = hydro.endpoint, values_from = MedDelta) %>% dplyr::select(COMID:Wet_BFL_Mag_50)
# delta_med
# 
# write.csv(delta_med, "output_data/00_delta_median_comids_2116.csv")
# 
# 
# unique(delta_long$Relative_Alteration)
# ## binned ffm
# delta_bin <- delta_long %>%
#   rename(COMID = comid) %>%
#   dplyr::select(COMID, hydro.endpoint, Relative_Alteration)  %>%
#   # mutate(Relative_Alteration = as.factor(Relative_Alteration)) %>%
#   mutate(Relative_Alteration = case_when(Relative_Alteration == "Depleted, Low Alteration" ~ 1,
#                                          Relative_Alteration == "Depleted, Medium Alteration" ~ 2,
#                                          Relative_Alteration == "Depleted, High Alteration" ~ 3,
#                                          Relative_Alteration == "Depleted, Very High Alteration" ~ 4,
#                                          Relative_Alteration == "Augmented, Low Alteration" ~ 5,
#                                          Relative_Alteration == "Augmented, Medium Alteration" ~ 6,
#                                          Relative_Alteration == "Augmented, High Alteration" ~ 7,
#                                          Relative_Alteration == "Augmented, Very High Alteration" ~ 8,)) %>%
#   pivot_wider(names_from = hydro.endpoint, values_from =Relative_Alteration)# %>% dplyr::select(COMID, DS_Mag_50, FA_Mag:Wet_BFL_Mag_50)
# 
# ## join with all data by comid - all RB9
# data_hyd_sf <- inner_join(DataComsx, delta_med, by = "COMID") ## 209 reaches don't match
# 
# length(unique(DataComsx$COMID)) ## 2179
# length(unique(delta_med$COMID)) ## 2116
# length(unique(data_hyd_sf$COMID)) ## 2116
# 
# names(data_hyd_sf)
# dim(data_hyd_sf) ## 16891
# ## save out
# 
# save(data_hyd_sf, file = "ignore/00_RB9_grdded_data.RData")
# 
# 
# # Make raster of all data & hydro -----------------------------------------
# 
# ## make spatial and transformCRS
# coordinates(data_hyd_sf) <- ~X+Y
# data_hyd_sf
# projection(data_hyd_sf) <- "+proj=geocent +ellps=GRS80 +units=m +no_defs"
# 
# # data_hyd_sf <- spTransform(data_hyd_sf, CRS("+proj=geocent +ellps=GRS80 +units=m +no_defs")) 
# 
# ## create template raster
# 
# ## dims etc from CurrentGridFeb14.grd
# 
# x <- raster(ncol=701, nrow=649, xmn=423638.013766974, xmx=563838.013766974, ymn=3600402.14370233 , ymx=3730202.14370233)
# 
# projection(x) <- "+proj=geocent +ellps=GRS80 +units=m +no_defs"
# crs(x)
# 
# #Create list of column names you want to rasterize
# fields <- names(data_hyd_sf) [c(7:70, 76:85)]
# fields
# 
# ## make rasters of each env var
# for (i in fields){
#   x[[i]]<-raster::rasterize(data_hyd_sf, x, field=i, na.rm =TRUE, sp = TRUE)
#   projection(x)<-"+proj=geocent +ellps=GRS80 +units=m +no_defs"
#   x <- stack(x)
# }
# 
# x@layers ## check
# ## define and save layer names
# layerNames <- names(x)
# save(layerNames, file = "output_data/00_final_raster_layer_names.RData")
# 
# # plot(x[[1]]) ## to check
# 
# ## save out
# writeRaster(x, "ignore/00_raw_final_data_raster.tif", format="GTiff", crs="+proj=geocent +ellps=GRS80 +units=m +no_defs", overwrite=TRUE)
# 
# 
# # Binned data -------------------------------------------------------------
# 
# 
# ## join with all data by comid - all RB9 - binned data
# data_hyd_sf <- inner_join(DataComsx, delta_bin, by = "COMID") ## 209 reaches don't match
# 
# 
# 
# length(unique(DataComsx$COMID)) ## 2179
# length(unique(delta_med$COMID)) ## 2116
# length(unique(data_hyd_sf$COMID)) ## 2116
# names(data_hyd_sf)
# head(data_hyd_sf)
# dim(data_hyd_sf) ## 16891
# str(data_hyd_sf)
# ## save out
# 
# save(data_hyd_sf, file = "ignore/00_RB9_grdded_data_binned.RData")
# # load(file = "ignore/00_RB9_grdded_data_binned.RData")
# # load(file = "ignore/03_all_env_data_gridded_comid.RData")
# 
# # ## make spatial and transformCRS
# coordinates(data_hyd_sf) <- ~X+Y
# data_hyd_sf
# projection(data_hyd_sf) <- "+proj=geocent +ellps=GRS80 +units=m +no_defs"
# 
# # data_hyd_sf <- spTransform(data_hyd_sf, CRS("+proj=geocent +ellps=GRS80 +units=m +no_defs"))
# 
# ## create template raster
# 
# ## dims etc from CurrentGridFeb14.grd
# 
# x <- raster(ncol=701, nrow=649, xmn=423638.013766974, xmx=563838.013766974, ymn=3600402.14370233 , ymx=3730202.14370233)
# 
# projection(x) <- "+proj=geocent +ellps=GRS80 +units=m +no_defs"
# crs(x)
# 
# #Create list of column names you want to rasterize
# fields <- names(data_hyd_sf) [c(7:70, 74:82)]
# fields
# i
# 
# ## make rasters of each env var
# for (i in fields){
#   x[[i]]<-raster::rasterize(data_hyd_sf, x, field=i, na.rm =TRUE, sp = TRUE)
#   projection(x)<-"+proj=geocent +ellps=GRS80 +units=m +no_defs"
#   x <- stack(x)
# }
# 
# x@layers ## check
# ## define and save layer names
# layerNames <- names(x)
# save(layerNames, file = "output_data/00_final_raster_layer_names_binned.RData")
# 
# # plot(x[[1]]) ## to check
# 
# ## save out
# writeRaster(x, "ignore/00_raw_final_data_raster_binned.tif", format="GTiff", crs="+proj=geocent +ellps=GRS80 +units=m +no_defs", overwrite=TRUE)
# # 


# Add Comids - not working properly   --------------------------------------------------

## make raster mask
# rmask <- x[[1]]
# crs(rmask) <- "+proj=utm +zone=11 +datum=NAD83"
# crs(x) <-  "+proj=utm +zone=11 +datum=NAD83"
# 
# coms <- raster("/Users/katieirving/SCCWRP/SD Hydro Vulnerability Assessment - General/Data/SpatialData/NHD_reaches_RB9_castreamclassification_PolylineToRaster_v3.tif")
# coms ## 
# names(coms) <- "COMID"
# # coms<-projectRaster(coms, crs = crs(rmask))
# # coms
# 
# 
# ## resample to mask layer
# comsRE <- resample(coms, rmask, method = "ngb")
# comsRE
# 
# comx <- na.omit(as.data.frame(comsRE))
# length(unique(comx$COMID)) ## 2000
# # test <- stack(comsRE, rmask)
# # test <- na.omit(as.data.frame(test, xy=T))
# 
# head(test)
# 
# ## stack with other rasters
# rstack <- stack(x, comsRE)
# plot(rstack)
# 
# ## check and plot
# # rDF <- na.omit(as.data.frame(rstack, xy=T))
# # length(unique(rDF$NHDplus_RB9_csc_Raster))
# # rDFSP <- rDF %>%
# #   st_as_sf(coords=c("x", "y"), crs=26911, remove=F) %>%
# #   filter(!NHDplus_RB9_csc_Raster == 0)
# # 
# # plot(comsRE)
# # plot(rDFSP, add=T)
# 
# ## save raster stack
# writeRaster(rstack, "ignore/00_raw_new_data_raster_Coms_zero.tif", format="GTiff", crs="+proj=geocent +ellps=GRS80 +units=m +no_defs", overwrite=TRUE)
# 
# ## save df
# save(rDF, file="ignore/00_raw_new_data_coms_zero.RData")
# 
# ## for now, get comids from nhdplustools
# 
# rDF <- rDF %>% mutate(ID = 1:nrow(rDF)) 
# 
# orig.sdata.segs <- rDF %>%
#   dplyr::select(x,y, ID) %>%
#   st_as_sf(coords=c("x", "y"), crs=26911, remove=F)%>%
#   st_transform(crs=32611) %>%
#   arrange(ID)
# 
# # use nhdtools to get comids
# data_all_coms <- orig.sdata.segs %>%
#   group_split(ID) %>%
#   set_names(., orig.sdata.segs$ID) %>%
#   map(~discover_nhdplus_id(.x$geometry))
# 
# # flatten into single dataframe instead of list
# data_segs_df <-data_all_coms %>% flatten_dfc() %>% t() %>%
#   as.data.frame() %>%
#   rename("COMID"=V1) %>% rownames_to_column(var = "ID") %>%
#   mutate(ID = as.integer(ID))
# data_segs_df
# 
# ## join back to DF
# rDFComs <- full_join(rDF, data_segs_df, by = "ID")
# 
# head(rDFComs)
# 
# 
# save(rDFComs, file="ignore/00_raw_new_data_coms_nhd.RData")
# 
# ## save comids as raster to stack with other env
# 
# rstack <- stack("ignore/00_raw_new_data_raster_Coms_zero.tif")
# names(rstack)
# rstack
# ## layer names
# load(file = "output_data/00_raster_layer_names.RData")
# layerNames
# names(rstack) <- c(layerNames, "COMIDGIS")
# 
# ## env df with comids
# load(file="ignore/00_raw_new_data_coms_nhd.RData")
# head(rDFComs)
# names(rDFComs)
# 
# ## make spatial and transformCRS
# coordinates(rDFComs) <- ~x+y
# 
# projection(rDFComs) <- "+proj=geocent +ellps=GRS80 +units=m +no_defs"
# ## make raster and add to stack
# 
# x <- raster(ncol=701, nrow=649, xmn=423638.013766974, xmx=563838.013766974, ymn=3600402.14370233 , ymx=3730202.14370233)
# projection(x) <- "+proj=geocent +ellps=GRS80 +units=m +no_defs"
# crs(x)
# 
# #Create list of column names you want to rasterize
# fields <- names(rDFComs) [c(1:66)]
# fields
# 
# 
# ## make rasters of each env var
# for (i in fields){
#   x[[i]]<-raster::rasterize(rDFComs, x, field=i, na.rm =TRUE, sp = TRUE)
#   projection(x)<-"+proj=geocent +ellps=GRS80 +units=m +no_defs"
#   x <- stack(x)
# }
# 
# 
# layerNames <- names(x)
# layerNames
# x
# 
# save(layerNames, file = "output_data/00_raster_layer_names.RData")
# 
# writeRaster(x, "ignore/00_raw_new_data_raster_Coms_zero.tif", format="GTiff", crs="+proj=geocent +ellps=GRS80 +units=m +no_defs", overwrite=TRUE)
# # 
# 
# # stuff not working -------------------------------------------------------
# ## upload nhd points
# nhdPts <- st_read("/Users/katieirving/SCCWRP/SD Hydro Vulnerability Assessment - General/Data/SpatialData/NHD_reaches_RB9_points/NHD_reaches_RB9_points.shp")
# dim(nhdPts)
# 
# crs(x) <- "+proj=utm +zone=11 +datum=NAD83"
# ?extract
# test <- raster::extract(x, nhdPts)
# dim(test)
# dim(na.omit(test))
# ## upload raster mask
# rmask <- raster("ignore/02_mask_raster_network.tif")
# crs(rmask)
# 
# 
# ## convert to df
# r_df <- as.data.frame(rmask, xy=T)
# r_df <- na.omit(r_df)
# 
# ## make spatial
# r_dfSP <- r_df %>%
#   st_as_sf(coords=c("x", "y"), crs=4269, remove=F) 
# 
# head(r_dfSP)
# dim(r_dfSP)
# 
# coms <- raster("/Users/katieirving/SCCWRP/SD Hydro Vulnerability Assessment - General/Data/SpatialData/NHDplus_RB9_Raster_v2/NHDplus_RB9_csc_Raster.tif")
# coms ## no values are zeros, slightly different res and ncells
# plot(coms)
# ## resample to mask layer
# comsRE <- resample(coms, rmask, method = "ngb")
# comsRE
# 
# test <- stack(comsRE, rmask)
# test
# test <- na.omit(test)
# test
# ## make dataframe
# comsDF <- as.data.frame(coms, xy=T) 
# ## change name of comid raster
# names(comsDF)[3] <-"COMID"
# 
# ## some comids are 0, replacewith NA
# comsDF$COMID[comsDF$COMID == 0] <- NA
# comsDF <- na.omit(comsDF)
# length(unique(comsDF$COMID)) ## 1993
# 
# dim(comsDF)
# head(comsDF)
